<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dante's Inferno Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Arial', sans-serif;
            color: white;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #backgroundLayer {
            position: absolute;
            width: 10000%;
            height: 100%;
            background-image: url('https://i.postimg.cc/FRnyFwQF/fdaf6de2-458b-4e18-8d9d-d3a0a08f6158.png');
            background-size: contain;
            background-position: left top;
            background-repeat: repeat-x;
            z-index: 1;
            transition: transform 0.1s ease-out;
        }

        .level-two-background {
            background-image: url('https://i.postimg.cc/R0BxKp7p/39c65714-400a-4756-b649-09ed580d2ca1.png') !important;
            background-size: contain;
            background-repeat: repeat-x !important;
            background-color: #000000 !important;
        }
       
        .level-three-background {
            background-image: url('https://i.postimg.cc/fbxgsw0B/d685965a-3452-435f-9664-f202d5e53633.jpg') !important;
            background-size: contain;
            background-repeat: repeat-x !important;
            background-color: #000000 !important;
        }

        #player {
            position: absolute;
            width: 80px;
            height: 120px;
            background-image: url('https://i.postimg.cc/NfDdpJvP/Senza-titolo-3-20250310144624.png');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 10;
            transition: transform 0.1s;
        }

        .player-invincible {
            animation: blink 0.3s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .enemy {
            position: absolute;
            width: 70px;
            height: 70px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 5;
            transition: transform 0.2s, left 0.3s, bottom 0.3s;
        }

        .demon-type-1 {
            background-image: url('https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png');
            width: 90px;
            height: 90px;
        }

        .demon-type-2 {
            background-image: url('https://i.postimg.cc/90qzyQrS/Senza-titolo-2-20250224154252.png');
            width: 100px;
            height: 100px;
        }
       
        .demon-type-3 {
            background-image: url('https://i.postimg.cc/4d0mK9NV/Senza-titolo-2-20250224154646.png');
            width: 95px;
            height: 95px;
        }
       
        .level-two-enemy-1 {
            background-image: url('https://i.postimg.cc/1zdRkz6h/2-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-two-enemy-2 {
            background-image: url('https://i.postimg.cc/VdBG6yqt/3-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-two-enemy-3 {
            background-image: url('https://i.postimg.cc/K1RS6vTf/4-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-two-enemy-4 {
            background-image: url('https://i.postimg.cc/mz62YFNx/5-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }

        .level-three-enemy-1 {
            background-image: url('https://i.postimg.cc/Qx42Yxp7/Cattura-removebg-preview-7.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-three-enemy-2 {
            background-image: url('https://i.postimg.cc/XqNPxTqx/Senza-titolo-4-20250310150944.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-three-enemy-3 {
            background-image: url('https://i.postimg.cc/NjKW3q4z/Cattura-removebg-preview-6.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-three-enemy-4 {
            background-image: url('https://i.postimg.cc/bNB5HVhH/2222-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }

        .portal {
            position: absolute;
            width: 100px;
            height: 100px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 5;
            animation: portalPulse 1.5s infinite alternate;
        }

        .level-one-portal {
            background-image: url('https://i.postimg.cc/sBHkdx66/portal.jpg') !important;
        }

        .other-level-portal {
            background-image: url('https://i.postimg.cc/jWvCgFnH/portal.png') !important;
        }

        @keyframes portalPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        #gameStats {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            font-size: 24px;
            z-index: 20;
            text-shadow: 2px 2px #000;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4a4a4a;
        }

        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            border: 3px solid #4a4a4a;
            min-width: 300px;
        }

        .game-over h2 {
            font-size: 36px;
            color: #ff0000;
            margin-bottom: 20px;
            text-shadow: 2px 2px #000;
        }

        .game-over p {
            font-size: 24px;
            margin: 10px 0;
            color: #fff;
        }

        .game-over button {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .game-over button:hover {
            background-color: #45a049;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            z-index: 20;
            border: 2px solid #4a4a4a;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            border: 3px solid #4a4a4a;
        }

        .level-complete h2 {
            font-size: 36px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        #soundButton {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
       
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }
       
        #startScreen h1 {
            font-size: 60px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.8);
        }
       
        #startScreen p {
            font-size: 24px;
            margin-bottom: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            max-width: 600px;
        }
       
        #startScreen .instructions {
            font-size: 28px;
            margin-top: 40px;
            animation: pulse 1.5s infinite;
        }

        #characterDisplay {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        #danteChar, #demonChar {
            height: 150px;
            margin: 0 20px;
            filter: drop-shadow(5px 5px 5px rgba(0, 0, 0, 0.7));
        }

        #debugInfo {
            position: fixed;
            bottom: 70px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 1000;
        }
       
        #livesContainer {
            display: flex;
            align-items: center;
        }
       
        .life-icon {
            width: 25px;
            height: 25px;
            background-color: #ff0000;
            border-radius: 50%;
            margin-left: 5px;
            display: inline-block;
            box-shadow: 0 0 5px #ff0000;
        }
       
        #finalImage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.postimg.cc/fLnbd73s/b5a34228-cfa9-47e3-8a87-8a7b7aa9d1aa.png');
            background-size: cover;
            background-position: center;
            z-index: 150;
            display: none;
        }

        /* Mobile controls */
        #mobileControls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .mobile-button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 2px solid #4a4a4a;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }

        #leftButton {
            position: absolute;
            bottom: 20px;
            left: 20px;
        }

        #rightButton {
            position: absolute;
            bottom: 20px;
            left: 100px;
        }

        #jumpButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }

        #runButton {
            position: absolute;
            bottom: 20px;
            right: 100px;
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: block;
            }
            
            #controls {
                display: none;
            }
            
            #gameStats {
                font-size: 18px;
            }
            
            #startScreen h1 {
                font-size: 40px;
            }
            
            #startScreen p {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="backgroundLayer"></div>
       
        <div id="startScreen">
            <h1>Dante's Adventure</h1>
            <p>Aiuta Dante a attraversare l'Inferno evitando i demoni!</p>
           
            <div id="characterDisplay">
                <img id="danteChar" src="https://i.postimg.cc/NfDdpJvP/Senza-titolo-3-20250310144624.png" alt="Dante" />
                <img id="demonChar" src="https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png" alt="Demone" />
            </div>
           
            <p class="instructions">Premi ENTER per iniziare</p>
        </div>

        <div id="gameStats">
            <div>PUNTEGGIO: <span id="scoreDisplay">0</span></div>
            <div>MONDO: <span id="worldDisplay">1-1</span></div>
            <div>TEMPO: <span id="timeDisplay">400</span></div>
            <div id="livesContainer">VITE: <span id="livesDisplay"></span></div>
        </div>
       
        <div id="controls">
            ‚Üê ‚Üí per muoversi | SPAZIO per saltare | SHIFT per correre
        </div>
       
        <div id="mobileControls">
            <button id="leftButton" class="mobile-button">‚Üê</button>
            <button id="rightButton" class="mobile-button">‚Üí</button>
            <button id="jumpButton" class="mobile-button">‚Üë</button>
            <button id="runButton" class="mobile-button">R</button>
        </div>
       
        <button id="soundButton">üîä</button>
       
        <div id="debugInfo">
            Screen: <span id="screenPositionDisplay">0</span>
        </div>

        <div id="finalImage"></div>
    </div>

    <script>
        // Wait for DOM to fully load
        document.addEventListener('DOMContentLoaded', function() {
            // Preload images to prevent loading delays
            const imagesToPreload = [
                'https://i.postimg.cc/FRnyFwQF/fdaf6de2-458b-4e18-8d9d-d3a0a08f6158.png',
                'https://i.postimg.cc/R0BxKp7p/39c65714-400a-4756-b649-09ed580d2ca1.png',
                'https://i.postimg.cc/fbxgsw0B/d685965a-3452-435f-9664-f202d5e53633.jpg',
                'https://i.postimg.cc/NfDdpJvP/Senza-titolo-3-20250310144624.png',
                'https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png',
                'https://i.postimg.cc/90qzyQrS/Senza-titolo-2-20250224154252.png',
                'https://i.postimg.cc/4d0mK9NV/Senza-titolo-2-20250224154646.png',
                'https://i.postimg.cc/1zdRkz6h/2-removebg-preview.png',
                'https://i.postimg.cc/VdBG6yqt/3-removebg-preview.png',
                'https://i.postimg.cc/K1RS6vTf/4-removebg-preview.png',
                'https://i.postimg.cc/mz62YFNx/5-removebg-preview.png',
                'https://i.postimg.cc/Qx42Yxp7/Cattura-removebg-preview-7.png',
                'https://i.postimg.cc/XqNPxTqx/Senza-titolo-4-20250310150944.png',
                'https://i.postimg.cc/NjKW3q4z/Cattura-removebg-preview-6.png',
                'https://i.postimg.cc/bNB5HVhH/2222-removebg-preview.png',
                'https://i.postimg.cc/sBHkdx66/portal.jpg',
                'https://i.postimg.cc/jWvCgFnH/portal.png',
                'https://i.postimg.cc/fLnbd73s/b5a34228-cfa9-47e3-8a87-8a7b7aa9d1aa.png'
            ];
            
            function preloadImages() {
                imagesToPreload.forEach(imgSrc => {
                    const img = new Image();
                    img.src = imgSrc;
                });
            }
            
            preloadImages();

            // Get DOM elements
            const startScreen = document.getElementById('startScreen');
            const gameContainer = document.getElementById('gameContainer');
            const backgroundLayer = document.getElementById('backgroundLayer');
            const screenPositionDisplay = document.getElementById('screenPositionDisplay');
            const livesDisplay = document.getElementById('livesDisplay');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const timeDisplay = document.getElementById('timeDisplay');
            const worldDisplay = document.getElementById('worldDisplay');
            const soundButton = document.getElementById('soundButton');
            const finalImage = document.getElementById('finalImage');
            
            // Mobile controls
            const leftButton = document.getElementById('leftButton');
            const rightButton = document.getElementById('rightButton');
            const jumpButton = document.getElementById('jumpButton');
            const runButton = document.getElementById('runButton');
           
            let player, gameLoopRunning = false;
            let gameElements = [];
            let timerInterval;
            let animationFrameId;
           
            // Game variables
            let lives = 15;
            let isInvincible = false;
            let invincibleDuration = 2000;
            let playerX = 100;
            let playerY = 100;
            let isJumping = false;
            let isFalling = false;
            let jumpHeight = 0;
            let jumpMax = 150;
            let moveSpeed = 8; // Adjusted for better gameplay
            let facingRight = true;
            let score = 0;
            let timeRemaining = 400;
            let portalObject = null;
            let currentLevel = 1;
           
            // Background variables
            let backgroundPos = 0;
            let levelWidth = 50000;
            let viewportWidth = window.innerWidth;
            let maxBackgroundPos = levelWidth - viewportWidth;
            let currentScreen = 0;
            let screenWidth = viewportWidth;
           
            // Player position constraints
            let playerMinX = 50; 
            let playerMaxX = viewportWidth / 2;
           
            // Level 1 demon types and positions
            const demonTypes = [
                { type: 1, url: 'https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png', speed: 0.8 },
                { type: 2, url: 'https://i.postimg.cc/90qzyQrS/Senza-titolo-2-20250224154252.png', speed: 1.2 },
                { type: 3, url: 'https://i.postimg.cc/4d0mK9NV/Senza-titolo-2-20250224154646.png', speed: 1.6 }
            ];
           
            // Level 2 demon types
            const level2DemonTypes = [
                { type: 1, url: 'https://i.postimg.cc/1zdRkz6h/2-removebg-preview.png', speed: 0.8, class: 'level-two-enemy-1' },
                { type: 2, url: 'https://i.postimg.cc/VdBG6yqt/3-removebg-preview.png', speed: 1.2, class: 'level-two-enemy-2' },
                { type: 3, url: 'https://i.postimg.cc/K1RS6vTf/4-removebg-preview.png', speed: 1.6, class: 'level-two-enemy-3' },
                { type: 4, url: 'https://i.postimg.cc/mz62YFNx/5-removebg-preview.png', speed: 1.4, class: 'level-two-enemy-4' }
            ];
           
            // Level 3 demon types
            const level3DemonTypes = [
                { type: 1, url: 'https://i.postimg.cc/Qx42Yxp7/Cattura-removebg-preview-7.png', speed: 0.8, class: 'level-three-enemy-1' },
                { type: 2, url: 'https://i.postimg.cc/XqNPxTqx/Senza-titolo-4-20250310150944.png', speed: 1.2, class: 'level-three-enemy-2' },
                { type: 3, url: 'https://i.postimg.cc/NjKW3q4z/Cattura-removebg-preview-6.png', speed: 1.6, class: 'level-three-enemy-3' },
                { type: 4, url: 'https://i.postimg.cc/bNB5HVhH/2222-removebg-preview.png', speed: 1.4, class: 'level-three-enemy-4' }
            ];
           
            // Array for active demons
            let activeDemons = [];
           
            // Key state tracking
            const keysPressed = {
                ArrowLeft: false,
                ArrowRight: false,
                ArrowUp: false,
                Space: false,
                ShiftLeft: false
            };
           
            // Event listeners for keyboard
            function setupKeyboardListeners() {
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && startScreen.style.display !== 'none') {
                        startGame();
                        return;
                    }
                   
                    if (event.key === 'ArrowLeft') keysPressed.ArrowLeft = true;
                    if (event.key === 'ArrowRight') keysPressed.ArrowRight = true;
                    if (event.key === 'ArrowUp') keysPressed.ArrowUp = true;
                    if (event.key === ' ' || event.key === 'Space') keysPressed.Space = true;
                    if (event.key === 'Shift') keysPressed.ShiftLeft = true;
                });
               
                document.addEventListener('keyup', function(event) {
                    if (event.key === 'ArrowLeft') keysPressed.ArrowLeft = false;
                    if (event.key === 'ArrowRight') keysPressed.ArrowRight = false;
                    if (event.key === 'ArrowUp') keysPressed.ArrowUp = false;
                    if (event.key === ' ' || event.key === 'Space') keysPressed.Space = false;
                    if (event.key === 'Shift') keysPressed.ShiftLeft = false;
                });
                
                // Setup mobile controls
                setupMobileControls();
            }
            
            // Setup mobile controls
            function setupMobileControls() {
                // Left button
                leftButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowLeft = true;
                });
                leftButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowLeft = false;
                });
                
                // Right button
                rightButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowRight = true;
                });
                rightButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowRight = false;
                });
                
                // Jump button
                jumpButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.Space = true;
                });
                jumpButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.Space = false;
                });
                
                // Run button
                runButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.ShiftLeft = true;
                });
                runButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.ShiftLeft = false;
                });
            }
           
            // Initialize lives display
            function initLives() {
                livesDisplay.innerHTML = '';
                for (let i = 0; i < lives; i++) {
                    const lifeIcon = document.createElement('span');
                    lifeIcon.className = 'life-icon';
                    livesDisplay.appendChild(lifeIcon);
                }
            }
           
            // Update lives display
            function updateLives() {
                livesDisplay.innerHTML = '';
                for (let i = 0; i < lives; i++) {
                    const lifeIcon = document.createElement('span');
                    lifeIcon.className = 'life-icon';
                    livesDisplay.appendChild(lifeIcon);
                }
               
                if (lives <= 0) {
                    gameOver();
                }
            }
           
            // Create a demon with specific type
            function createDemon(typeIndex, xPosition) {
                if (currentLevel === 1) {
                    // Check if this type of demon already exists and is active
                    if (activeDemons.some(demon => demon.type === demonTypes[typeIndex].type && demon.active)) {
                        return null;
                    }
                   
                    const demon = document.createElement('div');
                    demon.className = 'enemy';
                    demon.classList.add(`demon-type-${demonTypes[typeIndex].type}`);
                   
                    demon.style.left = xPosition + 'px';
                    demon.style.bottom = '100px';
                    gameContainer.appendChild(demon);
                    gameElements.push(demon);
                   
                    // Create demon object with reduced hitbox (75% of visual size)
                    let width = typeIndex === 0 ? 90 : (typeIndex === 1 ? 100 : 95);
                    let height = typeIndex === 0 ? 90 : (typeIndex === 1 ? 100 : 95);
                   
                    return {
                        element: demon,
                        x: xPosition,
                        y: 100,
                        width: width * 0.75,
                        height: height * 0.75,
                        type: demonTypes[typeIndex].type,
                        speed: demonTypes[typeIndex].speed,
                        active: true,
                        relativeX: xPosition - backgroundPos
                    };
                } else if (currentLevel === 2) {
                    // For level 2, use the new demon types
                    if (activeDemons.some(demon => demon.type === level2DemonTypes[typeIndex].type && demon.active)) {
                        return null;
                    }
                   
                    const demon = document.createElement('div');
                    demon.className = 'enemy';
                    demon.classList.add(level2DemonTypes[typeIndex].class);
                   
                    demon.style.left = xPosition + 'px';
                    demon.style.bottom = '100px';
                    gameContainer.appendChild(demon);
                    gameElements.push(demon);
                   
                    // All level 2 enemies have the same size
                    let width = 120;
                    let height = 120;
                   
                    return {
                        element: demon,
                        x: xPosition,
                        y: 100,
                        width: width * 0.75,
                        height: height * 0.75,
                        type: level2DemonTypes[typeIndex].type,
                        speed: level2DemonTypes[typeIndex].speed,
                        active: true,
                        relativeX: xPosition - backgroundPos
                    };
                }
                 else if (currentLevel === 3) {
                    // For level 3, use the level 3 demon types
                    if (activeDemons.some(demon => demon.type === level3DemonTypes[typeIndex].type && demon.active)) {
                        return null;
                    }
                   
                    const demon = document.createElement('div');
                    demon.className = 'enemy';
                    demon.classList.add(level3DemonTypes[typeIndex].class);
                   
                    demon.style.left = xPosition + 'px';
                    demon.style.bottom = '100px';
                    gameContainer.appendChild(demon);
                    gameElements.push(demon);
                   
                    // All level 3 enemies have the same size
                    let width = 120;
                    let height = 120;
                   
                    return {
                        element: demon,
                        x: xPosition,
                        y: 100,
                        width: width * 0.75,
                        height: height * 0.75,
                        type: level3DemonTypes[typeIndex].type,
                        speed: level3DemonTypes[typeIndex].speed,
                        active: true,
                        relativeX: xPosition - backgroundPos
                    };
                }
                
                return null;
            }
           
            // Create a portal at the specific position
            function createPortal(xPosition) {
                if (portalObject && portalObject.element) {
                    gameContainer.removeChild(portalObject.element);
                    gameElements = gameElements.filter(el => el !== portalObject.element);
                    portalObject = null;
                }
                
                const portal = document.createElement('div');
                portal.className = 'portal';
                
                // Use different portal images based on level
                if (currentLevel === 1) {
                    portal.classList.add('level-one-portal');
                } else {
                    portal.classList.add('other-level-portal');
                }
                
                portal.style.left = xPosition + 'px';
                portal.style.bottom = '100px';
                gameContainer.appendChild(portal);
                gameElements.push(portal);
                
                portalObject = {
                    element: portal,
                    x: xPosition,
                    y: 100,
                    width: 100,
                    height: 100,
                    relativeX: xPosition - backgroundPos
                };
            }
            
            // Create demons at specific screen positions
            function createDemonsAtScreenPositions() {
                // Clear any existing demons
                activeDemons.forEach(demon => {
                    if (demon.element) {
                        gameContainer.removeChild(demon.element);
                        gameElements = gameElements.filter(el => el !== demon.element);
                    }
                });
                activeDemons = [];
                
                // Level 1 demons placement
                if (currentLevel === 1) {
                    // Screen 1 (starting area)
                    let demon1 = createDemon(0, screenWidth * 1.5);
                    if (demon1) activeDemons.push(demon1);
                    
                    // Screen 2
                    let demon2 = createDemon(1, screenWidth * 2.5);
                    if (demon2) activeDemons.push(demon2);
                    
                    // Screen 3
                    let demon3 = createDemon(2, screenWidth * 3.5);
                    if (demon3) activeDemons.push(demon3);
                    
                    // Screen 4
                    let demon4 = createDemon(0, screenWidth * 4.5);
                    if (demon4) activeDemons.push(demon4);
                    
                    // Screen 5
                    let demon5 = createDemon(1, screenWidth * 5.5);
                    if (demon5) activeDemons.push(demon5);
                    
                    // Create a portal to level 2 at screen 6
                    createPortal(screenWidth * 6.5);
                }
                // Level 2 demons placement
                else if (currentLevel === 2) {
                    // More demons and different patterns for level 2
                    let demon1 = createDemon(0, screenWidth * 1.2);
                    if (demon1) activeDemons.push(demon1);
                    
                    let demon2 = createDemon(1, screenWidth * 2.3);
                    if (demon2) activeDemons.push(demon2);
                    
                    let demon3 = createDemon(2, screenWidth * 3.1);
                    if (demon3) activeDemons.push(demon3);
                    
                    let demon4 = createDemon(3, screenWidth * 4.2);
                    if (demon4) activeDemons.push(demon4);
                    
                    let demon5 = createDemon(0, screenWidth * 5.2);
                    if (demon5) activeDemons.push(demon5);
                    
                    let demon6 = createDemon(1, screenWidth * 6.1);
                    if (demon6) activeDemons.push(demon6);
                    
                    // Create a portal to level 3 at screen 6.8
                    createPortal(screenWidth * 6.8);
                }
                // Level 3 demons placement
                else if (currentLevel === 3) {
                    // Even more demons for level 3
                    let demon1 = createDemon(0, screenWidth * 1.1);
                    if (demon1) activeDemons.push(demon1);
                    
                    let demon2 = createDemon(1, screenWidth * 2.1);
                    if (demon2) activeDemons.push(demon2);
                    
                    let demon3 = createDemon(2, screenWidth * 3.0);
                    if (demon3) activeDemons.push(demon3);
                    
                    let demon4 = createDemon(3, screenWidth * 4.0);
                    if (demon4) activeDemons.push(demon4);
                    
                    let demon5 = createDemon(0, screenWidth * 5.0);
                    if (demon5) activeDemons.push(demon5);
                    
                    let demon6 = createDemon(1, screenWidth * 5.8);
                    if (demon6) activeDemons.push(demon6);
                    
                    let demon7 = createDemon(2, screenWidth * 6.5);
                    if (demon7) activeDemons.push(demon7);
                    
                    // Create final portal at screen 7.2
                    createPortal(screenWidth * 7.2);
                }
            }
            
            // Create player character
            function createPlayer() {
                player = document.createElement('div');
                player.id = 'player';
                player.style.left = playerX + 'px';
                player.style.bottom = playerY + 'px';
                gameContainer.appendChild(player);
                gameElements.push(player);
            }
            
            // Movement and controls handling
            function handlePlayerMovement() {
                const baseSpeed = 5;
                const runMultiplier = 1.5;
                const currentSpeed = keysPressed.ShiftLeft ? baseSpeed * runMultiplier : baseSpeed;
                
                // Handle left movement
                if (keysPressed.ArrowLeft) {
                    facingRight = false;
                    player.style.transform = 'scaleX(-1)';
                    
                    // If player is not at the left edge of screen
                    if (playerX > playerMinX) {
                        playerX -= currentSpeed;
                    } 
                    // If player is at left edge but background can still move
                    else if (backgroundPos > 0) {
                        backgroundPos -= currentSpeed;
                        // Update active demons and portal positions when background moves
                        activeDemons.forEach(demon => {
                            demon.relativeX = demon.x - backgroundPos;
                            demon.element.style.left = demon.relativeX + 'px';
                        });
                        
                        if (portalObject) {
                            portalObject.relativeX = portalObject.x - backgroundPos;
                            portalObject.element.style.left = portalObject.relativeX + 'px';
                        }
                    }
                }
                
                // Handle right movement
                if (keysPressed.ArrowRight) {
                    facingRight = true;
                    player.style.transform = 'scaleX(1)';
                    
                    // If player is not at the right threshold of screen
                    if (playerX < playerMaxX) {
                        playerX += currentSpeed;
                    } 
                    // If player is at right threshold but background can still move
                    else if (backgroundPos < maxBackgroundPos) {
                        backgroundPos += currentSpeed;
                        // Update active demons and portal positions when background moves
                        activeDemons.forEach(demon => {
                            demon.relativeX = demon.x - backgroundPos;
                            demon.element.style.left = demon.relativeX + 'px';
                        });
                        
                        if (portalObject) {
                            portalObject.relativeX = portalObject.x - backgroundPos;
                            portalObject.element.style.left = portalObject.relativeX + 'px';
                        }
                    }
                    // If player is at right threshold and background can't move anymore
                    else {
                        playerX += currentSpeed;
                        // Make sure player doesn't go off-screen
                        if (playerX > viewportWidth - 80) {
                            playerX = viewportWidth - 80;
                        }
                    }
                }
                
                // Handle jumping with Space or ArrowUp
                if ((keysPressed.Space || keysPressed.ArrowUp) && !isJumping && !isFalling) {
                    isJumping = true;
                    isFalling = false;
                    jumpHeight = 0;
                }
                
                // Handle jumping physics
                if (isJumping) {
                    jumpHeight += 5;
                    playerY += 10;
                    
                    if (jumpHeight >= jumpMax) {
                        isJumping = false;
                        isFalling = true;
                    }
                }
                // Handle falling physics
                else if (isFalling) {
                    playerY -= 10;
                    
                    if (playerY <= 100) { // Ground level
                        playerY = 100;
                        isFalling = false;
                        jumpHeight = 0;
                    }
                }
                
                // Update player position
                player.style.left = playerX + 'px';
                player.style.bottom = playerY + 'px';
                
                // Update background position
                backgroundLayer.style.transform = `translateX(-${backgroundPos}px)`;
                
                // Update current screen calculation
                currentScreen = Math.floor(backgroundPos / screenWidth);
                screenPositionDisplay.textContent = currentScreen;
            }
            
            // Check for collisions with enemies
            function checkCollisions() {
                if (isInvincible) return;
                
                const playerRect = {
                    x: playerX,
                    y: playerY,
                    width: 80 * 0.7, // Reduced hitbox width
                    height: 120 * 0.7 // Reduced hitbox height
                };
                
                // Check for collisions with demons
                activeDemons.forEach(demon => {
                    if (!demon.active) return;
                    
                    const demonRect = {
                        x: demon.relativeX,
                        y: demon.y,
                        width: demon.width,
                        height: demon.height
                    };
                    
                    if (isColliding(playerRect, demonRect)) {
                        playerHit();
                    }
                });
                
                // Check for portal collision if portal exists
                if (portalObject) {
                    const portalRect = {
                        x: portalObject.relativeX,
                        y: portalObject.y,
                        width: portalObject.width,
                        height: portalObject.height
                    };
                    
                    if (isColliding(playerRect, portalRect)) {
                        reachedPortal();
                    }
                }
            }
            
            // Collision detection helper
            function isColliding(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }
            
            // Player hit by enemy
            function playerHit() {
                if (isInvincible) return;
                
                lives--;
                updateLives();
                
                // Make player temporarily invincible
                isInvincible = true;
                player.classList.add('player-invincible');
                
                setTimeout(() => {
                    isInvincible = false;
                    player.classList.remove('player-invincible');
                }, invincibleDuration);
            }
            
            // Player reached portal
            function reachedPortal() {
                // Stop timer temporarily
                clearInterval(timerInterval);
                
                if (currentLevel === 3) {
                    // Player beat the game!
                    showFinalScreen();
                } else {
                    // Show level complete message
                    const levelCompleteDiv = document.createElement('div');
                    levelCompleteDiv.className = 'level-complete';
                    levelCompleteDiv.innerHTML = `
                        <h2>Livello ${currentLevel} Completato!</h2>
                        <p>Punteggio attuale: ${score}</p>
                        <p>Vite rimaste: ${lives}</p>
                        <p>Tempo bonus: ${timeRemaining}</p>
                        <p>Premi ENTER per continuare</p>
                    `;
                    gameContainer.appendChild(levelCompleteDiv);
                    
                    // Add time bonus to score
                    score += timeRemaining * 10;
                    scoreDisplay.textContent = score;
                    
                    // Wait for ENTER press to start next level
                    const enterListener = function(event) {
                        if (event.key === 'Enter') {
                            gameContainer.removeChild(levelCompleteDiv);
                            document.removeEventListener('keydown', enterListener);
                            startNextLevel();
                        }
                    };
                    document.addEventListener('keydown', enterListener);
                }
            }
            
            // Show final victory screen
            function showFinalScreen() {
                // Display final image
                finalImage.style.display = 'block';
                
                // Create victory message
                const finalScoreDiv = document.createElement('div');
                finalScoreDiv.className = 'game-over';
                finalScoreDiv.innerHTML = `
                    <h2 style="color: #4CAF50;">Hai Vinto!</h2>
                    <p>Hai completato il viaggio attraverso l'Inferno!</p>
                    <p>Punteggio finale: ${score + timeRemaining * 20}</p>
                    <p>Grazie per aver giocato!</p>
                    <button id="playAgainBtn">Gioca Ancora</button>
                `;
                gameContainer.appendChild(finalScoreDiv);
                
                // Play again button
                document.getElementById('playAgainBtn').addEventListener('click', function() {
                    gameContainer.removeChild(finalScoreDiv);
                    finalImage.style.display = 'none';
                    resetGame();
                });
            }
            
            // Start next level
            function startNextLevel() {
                currentLevel++;
                timeRemaining = 400; // Reset timer
                
                // Reset player and background positions
                playerX = 100;
                playerY = 100;
                backgroundPos = 0;
                player.style.left = playerX + 'px';
                player.style.bottom = playerY + 'px';
                backgroundLayer.style.transform = `translateX(0)`;
                
                // Update world display
                worldDisplay.textContent = `${currentLevel}-1`;
                
                // Change background based on level
                if (currentLevel === 2) {
                    backgroundLayer.classList.add('level-two-background');
                } else if (currentLevel === 3) {
                    backgroundLayer.classList.remove('level-two-background');
                    backgroundLayer.classList.add('level-three-background');
                }
                
                // Create new demons for the level
                createDemonsAtScreenPositions();
                
                // Restart timer
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            // Game over function
            function gameOver() {
                // Stop the game loop
                cancelAnimationFrame(animationFrameId);
                gameLoopRunning = false;
                
                // Stop the timer
                clearInterval(timerInterval);
                
                const gameOverDiv = document.createElement('div');
                gameOverDiv.className = 'game-over';
                gameOverDiv.innerHTML = `
                    <h2>Game Over</h2>
                    <p>Punteggio: ${score}</p>
                    <button id="restartBtn">Riprova</button>
                `;
                gameContainer.appendChild(gameOverDiv);
                
                document.getElementById('restartBtn').addEventListener('click', function() {
                    gameContainer.removeChild(gameOverDiv);
                    resetGame();
                });
            }
            
            // Reset the game to initial state
            function resetGame() {
                // Clear all game elements
                gameElements.forEach(element => {
                    if (element && element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                });
                gameElements = [];
                activeDemons = [];
                
                // Reset game variables
                currentLevel = 1;
                lives = 15;
                score = 0;
                timeRemaining = 400;
                playerX = 100;
                playerY = 100;
                backgroundPos = 0;
                isJumping = false;
                isFalling = false;
                isInvincible = false;
                portalObject = null;
                
                // Reset UI
                scoreDisplay.textContent = score;
                worldDisplay.textContent = '1-1';
                timeDisplay.textContent = timeRemaining;
                updateLives();
                
                // Reset background
                backgroundLayer.classList.remove('level-two-background');
                backgroundLayer.classList.remove('level-three-background');
                
                // Start fresh game
                startGame();
            }
            
            // Update the countdown timer
            function updateTimer() {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    timeDisplay.textContent = timeRemaining;
                } else {
                    // Time's up - game over
                    gameOver();
                }
            }
            
            // Start the game
            function startGame() {
                // Hide start screen
                startScreen.style.display = 'none';
                
                // Initialize game elements
                createPlayer();
                createDemonsAtScreenPositions();
                initLives();
                
                // Start timer
                timerInterval = setInterval(updateTimer, 1000);
                
                // Start game loop
                if (!gameLoopRunning) {
                    gameLoopRunning = true;
                    gameLoop();
                }
            }
            
            // Main game loop
            function gameLoop() {
                handlePlayerMovement();
                checkCollisions();
                
                // Request next animation frame
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            
            // Initialize keyboard and mobile touch controls
            setupKeyboardListeners();
            
            // Sound toggle
            let soundOn = true;
            soundButton.addEventListener('click', function() {
                soundOn = !soundOn;
                soundButton.textContent = soundOn ? 'üîä' : 'üîá';
                // Additional sound logic would go here if audio was implemented
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                viewportWidth = window.innerWidth;
                screenWidth = viewportWidth;
                playerMaxX = viewportWidth / 2;
                maxBackgroundPos = levelWidth - viewportWidth;
                
                // Ensure player stays in bounds after resize
                if (playerX > viewportWidth - 80) {
                    playerX = viewportWidth - 80;
                    player.style.left = playerX + 'px';
                }
            });
        });
    </script>
</body>
</html>
