<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dante's Inferno Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Arial', sans-serif;
            color: white;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #backgroundLayer {
            position: absolute;
            width: 10000%;
            height: 100%;
            background-image: url('https://i.postimg.cc/FRnyFwQF/fdaf6de2-458b-4e18-8d9d-d3a0a08f6158.png');
            background-size: contain;
            background-position: left top;
            background-repeat: repeat-x;
            z-index: 1;
            transition: transform 0.1s ease-out;
        }

        .level-two-background {
            background-image: url('https://i.postimg.cc/R0BxKp7p/39c65714-400a-4756-b649-09ed580d2ca1.png') !important;
            background-size: contain;
            background-repeat: repeat-x !important;
            background-color: #000000 !important;
        }
       
        .level-three-background {
            background-image: url('https://i.postimg.cc/fbxgsw0B/d685965a-3452-435f-9664-f202d5e53633.jpg') !important;
            background-size: contain;
            background-repeat: repeat-x !important;
            background-color: #000000 !important;
        }

        #player {
            position: absolute;
            width: 80px;
            height: 120px;
            background-image: url('https://i.postimg.cc/NfDdpJvP/Senza-titolo-3-20250310144624.png');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 10;
            transition: transform 0.1s;
        }

        .player-invincible {
            animation: blink 0.3s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .enemy {
            position: absolute;
            width: 70px;
            height: 70px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 5;
            transition: transform 0.2s;
        }

        .demon-type-1 {
            background-image: url('https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png');
            width: 90px;
            height: 90px;
        }

        .demon-type-2 {
            background-image: url('https://i.postimg.cc/90qzyQrS/Senza-titolo-2-20250224154252.png');
            width: 100px;
            height: 100px;
        }
       
        .demon-type-3 {
            background-image: url('https://i.postimg.cc/4d0mK9NV/Senza-titolo-2-20250224154646.png');
            width: 95px;
            height: 95px;
        }
       
        .level-two-enemy-1 {
            background-image: url('https://i.postimg.cc/1zdRkz6h/2-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-two-enemy-2 {
            background-image: url('https://i.postimg.cc/VdBG6yqt/3-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-two-enemy-3 {
            background-image: url('https://i.postimg.cc/K1RS6vTf/4-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-two-enemy-4 {
            background-image: url('https://i.postimg.cc/mz62YFNx/5-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }

        .level-three-enemy-1 {
            background-image: url('https://i.postimg.cc/Qx42Yxp7/Cattura-removebg-preview-7.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-three-enemy-2 {
            background-image: url('https://i.postimg.cc/XqNPxTqx/Senza-titolo-4-20250310150944.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-three-enemy-3 {
            background-image: url('https://i.postimg.cc/NjKW3q4z/Cattura-removebg-preview-6.png') !important;
            width: 120px !important;
            height: 120px !important;
        }
       
        .level-three-enemy-4 {
            background-image: url('https://i.postimg.cc/bNB5HVhH/2222-removebg-preview.png') !important;
            width: 120px !important;
            height: 120px !important;
        }

        .portal {
            position: absolute;
            width: 100px;
            height: 100px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 5;
            animation: portalPulse 1.5s infinite alternate;
        }

        .level-one-portal {
            background-image: url('https://i.postimg.cc/sBHkdx66/portal.jpg') !important;
        }

        .other-level-portal {
            background-image: url('https://i.postimg.cc/jWvCgFnH/portal.png') !important;
        }

        @keyframes portalPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        #gameStats {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            font-size: 24px;
            z-index: 20;
            text-shadow: 2px 2px #000;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4a4a4a;
        }

        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            border: 3px solid #4a4a4a;
            min-width: 300px;
        }

        .game-over h2 {
            font-size: 36px;
            color: #ff0000;
            margin-bottom: 20px;
            text-shadow: 2px 2px #000;
        }

        .game-over p {
            font-size: 24px;
            margin: 10px 0;
            color: #fff;
        }

        .game-over button {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .game-over button:hover {
            background-color: #45a049;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            z-index: 20;
            border: 2px solid #4a4a4a;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            border: 3px solid #4a4a4a;
        }

        .level-complete h2 {
            font-size: 36px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        #soundButton {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
       
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }
       
        #startScreen h1 {
            font-size: 60px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.8);
        }
       
        #startScreen p {
            font-size: 24px;
            margin-bottom: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            max-width: 600px;
        }
       
        #startScreen .instructions {
            font-size: 28px;
            margin-top: 40px;
            animation: pulse 1.5s infinite;
        }

        #characterDisplay {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        #danteChar, #demonChar {
            height: 150px;
            margin: 0 20px;
            filter: drop-shadow(5px 5px 5px rgba(0, 0, 0, 0.7));
        }

        #debugInfo {
            position: fixed;
            bottom: 70px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 1000;
        }
       
        #livesContainer {
            display: flex;
            align-items: center;
        }
       
        .life-icon {
            width: 25px;
            height: 25px;
            background-color: #ff0000;
            border-radius: 50%;
            margin-left: 5px;
            display: inline-block;
            box-shadow: 0 0 5px #ff0000;
        }
       
        #finalImage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.postimg.cc/fLnbd73s/b5a34228-cfa9-47e3-8a87-8a7b7aa9d1aa.png');
            background-size: cover;
            background-position: center;
            z-index: 150;
            display: none;
        }

        /* Mobile controls */
        #mobileControls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .mobile-button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 2px solid #4a4a4a;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }

        #leftButton {
            position: absolute;
            bottom: 20px;
            left: 20px;
        }

        #rightButton {
            position: absolute;
            bottom: 20px;
            left: 100px;
        }

        #jumpButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }

        #runButton {
            position: absolute;
            bottom: 20px;
            right: 100px;
        }

        @media (max-width: 768px) {
            #mobileControls {
                display: block;
            }
            
            #controls {
                display: none;
            }
            
            #gameStats {
                font-size: 18px;
            }
            
            #startScreen h1 {
                font-size: 40px;
            }
            
            #startScreen p {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="backgroundLayer"></div>
       
        <div id="startScreen">
            <h1>Dante's Adventure</h1>
            <p>Aiuta Dante a attraversare l'Inferno evitando i demoni!</p>
           
            <div id="characterDisplay">
                <img id="danteChar" src="https://i.postimg.cc/NfDdpJvP/Senza-titolo-3-20250310144624.png" alt="Dante" />
                <img id="demonChar" src="https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png" alt="Demone" />
            </div>
           
            <p class="instructions">Premi ENTER per iniziare</p>
        </div>

        <div id="gameStats">
            <div>PUNTEGGIO: <span id="scoreDisplay">0</span></div>
            <div>MONDO: <span id="worldDisplay">1-1</span></div>
            <div>TEMPO: <span id="timeDisplay">400</span></div>
            <div id="livesContainer">VITE: <span id="livesDisplay"></span></div>
        </div>
       
        <div id="controls">
            ← → per muoversi | SPAZIO per saltare | SHIFT per correre
        </div>
       
        <div id="mobileControls">
            <button id="leftButton" class="mobile-button">←</button>
            <button id="rightButton" class="mobile-button">→</button>
            <button id="jumpButton" class="mobile-button">↑</button>
            <button id="runButton" class="mobile-button">R</button>
        </div>
       
        <button id="soundButton">🔊</button>
       
        <div id="debugInfo">
            Screen: <span id="screenPositionDisplay">0</span>
        </div>

        <div id="finalImage"></div>
    </div>

    <script>
        // Wait for DOM to fully load
        document.addEventListener('DOMContentLoaded', function() {
            // Preload images to prevent loading delays
            const imagesToPreload = [
                'https://i.postimg.cc/FRnyFwQF/fdaf6de2-458b-4e18-8d9d-d3a0a08f6158.png',
                'https://i.postimg.cc/R0BxKp7p/39c65714-400a-4756-b649-09ed580d2ca1.png',
                'https://i.postimg.cc/fbxgsw0B/d685965a-3452-435f-9664-f202d5e53633.jpg',
                'https://i.postimg.cc/NfDdpJvP/Senza-titolo-3-20250310144624.png',
                'https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png',
                'https://i.postimg.cc/90qzyQrS/Senza-titolo-2-20250224154252.png',
                'https://i.postimg.cc/4d0mK9NV/Senza-titolo-2-20250224154646.png',
                'https://i.postimg.cc/1zdRkz6h/2-removebg-preview.png',
                'https://i.postimg.cc/VdBG6yqt/3-removebg-preview.png',
                'https://i.postimg.cc/K1RS6vTf/4-removebg-preview.png',
                'https://i.postimg.cc/mz62YFNx/5-removebg-preview.png',
                'https://i.postimg.cc/Qx42Yxp7/Cattura-removebg-preview-7.png',
                'https://i.postimg.cc/XqNPxTqx/Senza-titolo-4-20250310150944.png',
                'https://i.postimg.cc/NjKW3q4z/Cattura-removebg-preview-6.png',
                'https://i.postimg.cc/bNB5HVhH/2222-removebg-preview.png',
                'https://i.postimg.cc/sBHkdx66/portal.jpg',
                'https://i.postimg.cc/jWvCgFnH/portal.png',
                'https://i.postimg.cc/fLnbd73s/b5a34228-cfa9-47e3-8a87-8a7b7aa9d1aa.png'
            ];
            
            function preloadImages() {
                imagesToPreload.forEach(imgSrc => {
                    const img = new Image();
                    img.src = imgSrc;
                });
            }
            
            preloadImages();

            // Get DOM elements
            const startScreen = document.getElementById('startScreen');
            const gameContainer = document.getElementById('gameContainer');
            const backgroundLayer = document.getElementById('backgroundLayer');
            const screenPositionDisplay = document.getElementById('screenPositionDisplay');
            const livesDisplay = document.getElementById('livesDisplay');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const timeDisplay = document.getElementById('timeDisplay');
            const worldDisplay = document.getElementById('worldDisplay');
            const soundButton = document.getElementById('soundButton');
            const finalImage = document.getElementById('finalImage');
            
            // Mobile controls
            const leftButton = document.getElementById('leftButton');
            const rightButton = document.getElementById('rightButton');
            const jumpButton = document.getElementById('jumpButton');
            const runButton = document.getElementById('runButton');
           
            let player, gameLoopRunning = false;
            let gameElements = [];
            let timerInterval;
            let animationFrameId;
            let levelTransitioning = false; // Flag to track level transition state
           
            // Game variables
            let lives = 15;
            let isInvincible = false;
            let invincibleDuration = 2000;
            let playerX = 100;
            let playerY = 100;
            let isJumping = false;
            let isFalling = false;
            let jumpHeight = 0;
            let jumpMax = 150;
            let moveSpeed = 8; // Adjusted for better gameplay
            let facingRight = true;
            let score = 0;
            let timeRemaining = 400;
            let portalObject = null;
            let currentLevel = 1;
           
            // Background variables
            let backgroundPos = 0;
            let levelWidth = 15000; // Reduced from 25000 to make level more compact
            let viewportWidth = window.innerWidth;
            let maxBackgroundPos = levelWidth - viewportWidth;
            let currentScreen = 0;
            let screenWidth = viewportWidth;
           
            // Player position constraints
            let playerMinX = 50; 
            let playerMaxX = viewportWidth / 2;
           
            // Level 1 demon types and positions
            const demonTypes = [
                { type: 1, url: 'https://i.postimg.cc/hPd7dpmj/Senza-titolo-2-20250224154443.png', speed: 0.8 },
                { type: 2, url: 'https://i.postimg.cc/90qzyQrS/Senza-titolo-2-20250224154252.png', speed: 1.2 },
                { type: 3, url: 'https://i.postimg.cc/4d0mK9NV/Senza-titolo-2-20250224154646.png', speed: 1.6 }
            ];
           
            // Level 2 demon types
            const level2DemonTypes = [
                { type: 1, url: 'https://i.postimg.cc/1zdRkz6h/2-removebg-preview.png', speed: 0.8, class: 'level-two-enemy-1' },
                { type: 2, url: 'https://i.postimg.cc/VdBG6yqt/3-removebg-preview.png', speed: 1.2, class: 'level-two-enemy-2' },
                { type: 3, url: 'https://i.postimg.cc/K1RS6vTf/4-removebg-preview.png', speed: 1.6, class: 'level-two-enemy-3' },
                { type: 4, url: 'https://i.postimg.cc/mz62YFNx/5-removebg-preview.png', speed: 1.4, class: 'level-two-enemy-4' }
            ];
           
            // Level 3 demon types
            const level3DemonTypes = [
                { type: 1, url: 'https://i.postimg.cc/Qx42Yxp7/Cattura-removebg-preview-7.png', speed: 0.8, class: 'level-three-enemy-1' },
                { type: 2, url: 'https://i.postimg.cc/XqNPxTqx/Senza-titolo-4-20250310150944.png', speed: 1.2, class: 'level-three-enemy-2' },
                { type: 3, url: 'https://i.postimg.cc/NjKW3q4z/Cattura-removebg-preview-6.png', speed: 1.6, class: 'level-three-enemy-3' },
                { type: 4, url: 'https://i.postimg.cc/bNB5HVhH/2222-removebg-preview.png', speed: 1.4, class: 'level-three-enemy-4' }
            ];
           
            // Array for active demons
            let activeDemons = [];
           
            // Key state tracking
            const keysPressed = {
                ArrowLeft: false,
                ArrowRight: false,
                ArrowUp: false,
                Space: false,
                ShiftLeft: false
            };
           
            // Event listeners for keyboard
            function setupKeyboardListeners() {
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' && startScreen.style.display !== 'none') {
                        startGame();
                        return;
                    }
                   
                    if (event.key === 'ArrowLeft') keysPressed.ArrowLeft = true;
                    if (event.key === 'ArrowRight') keysPressed.ArrowRight = true;
                    if (event.key === 'ArrowUp') keysPressed.ArrowUp = true;
                    if (event.key === ' ' || event.key === 'Space') keysPressed.Space = true;
                    if (event.key === 'Shift') keysPressed.ShiftLeft = true;
                });
               
                document.addEventListener('keyup', function(event) {
                    if (event.key === 'ArrowLeft') keysPressed.ArrowLeft = false;
                    if (event.key === 'ArrowRight') keysPressed.ArrowRight = false;
                    if (event.key === 'ArrowUp') keysPressed.ArrowUp = false;
                    if (event.key === ' ' || event.key === 'Space') keysPressed.Space = false;
                    if (event.key === 'Shift') keysPressed.ShiftLeft = false;
                });
                
                // Setup mobile controls
                setupMobileControls();
            }
            
            // Setup mobile controls
            function setupMobileControls() {
                // Left button
                leftButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowLeft = true;
                });
                leftButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowLeft = false;
                });
                
                // Right button
                rightButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowRight = true;
                });
                rightButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.ArrowRight = false;
                });
                
                // Jump button
                jumpButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.Space = true;
                });
                jumpButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.Space = false;
                });
                
                // Run button
                runButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    keysPressed.ShiftLeft = true;
                });
                runButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    keysPressed.ShiftLeft = false;
                });
            }
           
            // Initialize lives display
            function initLives() {
                livesDisplay.innerHTML = '';
                for (let i = 0; i < lives; i++) {
                    const lifeIcon = document.createElement('span');
                    lifeIcon.className = 'life-icon';
                    livesDisplay.appendChild(lifeIcon);
                }
            }
           
            // Update lives display
            function updateLives() {
                livesDisplay.innerHTML = '';
                for (let i = 0; i < lives; i++) {
                    const lifeIcon = document.createElement('span');
                    lifeIcon.className = 'life-icon';
                    livesDisplay.appendChild(lifeIcon);
                }
               
                if (lives <= 0) {
                    gameOver();
                }
            }
           
            // Create a demon with specific type
            function createDemon(typeIndex, xPosition) {
                const actualXPosition = backgroundPos + xPosition;
                
                if (currentLevel === 1) {
                    // Check if this type of demon already exists and is active
                    if (activeDemons.some(demon => demon.type === demonTypes[typeIndex].type && demon.active)) {
                        return null;
                    }
                   
                    const demon = document.createElement('div');
                    demon.className = 'enemy';
                    demon.classList.add(`demon-type-${demonTypes[typeIndex].type}`);
                   
                    demon.style.left = xPosition + 'px';
                    demon.style.bottom = '100px';
                    gameContainer.appendChild(demon);
                    gameElements.push(demon);
                   
                    // Create demon object with reduced hitbox (75% of visual size)
                    let width = typeIndex === 0 ? 90 : (typeIndex === 1 ? 100 : 95);
                    let height = typeIndex === 0 ? 90 : (typeIndex === 1 ? 100 : 95);
                   
                    return {
                        element: demon,
                        x: xPosition,
                        y: 100,
                        width: width * 0.75,
                        height: height * 0.75,
                        type: demonTypes[typeIndex].type,
                        speed: demonTypes[typeIndex].speed,
                        active: true,
                        relativeX: xPosition
                    };
                } else if (currentLevel === 2) {
                    // For level 2, use the new demon types
                    if (activeDemons.some(demon => demon.type === level2DemonTypes[typeIndex].type && demon.active)) {
                        return null;
                    }
                   
                    const demon = document.createElement('div');
                    demon.className = 'enemy';
                    demon.classList.add(level2DemonTypes[typeIndex].class);
                   
                    demon.style.left = xPosition + 'px';
                    demon.style.bottom = '100px';
                    gameContainer.appendChild(demon);
                    gameElements.push(demon);
                   
                    // Create demon object with reduced hitbox (75% of visual size)
                    let width = 120;
                    let height = 120;
                   
                   return {
                        element: demon,
                        x: xPosition,
                        y: 100,
                        width: width * 0.75,
                        height: height * 0.75,
                        type: level2DemonTypes[typeIndex].type,
                        speed: level2DemonTypes[typeIndex].speed,
                        active: true,
                        relativeX: xPosition
                    };
                } else if (currentLevel === 3) {
                    // For level 3, use level 3 demon types
                    if (activeDemons.some(demon => demon.type === level3DemonTypes[typeIndex].type && demon.active)) {
                        return null;
                    }
                   
                    const demon = document.createElement('div');
                    demon.className = 'enemy';
                    demon.classList.add(level3DemonTypes[typeIndex].class);
                   
                    demon.style.left = xPosition + 'px';
                    demon.style.bottom = '100px';
                    gameContainer.appendChild(demon);
                    gameElements.push(demon);
                   
                    // Create demon object with reduced hitbox (75% of visual size)
                    let width = 120;
                    let height = 120;
                   
                    return {
                        element: demon,
                        x: xPosition,
                        y: 100,
                        width: width * 0.75,
                        height: height * 0.75,
                        type: level3DemonTypes[typeIndex].type,
                        speed: level3DemonTypes[typeIndex].speed,
                        active: true,
                        relativeX: xPosition
                    };
                }
            }
           
            // Spawn demons at specific positions
            function spawnDemons() {
                // Clear existing demons
                activeDemons.forEach(demon => {
                    if (demon.element && demon.element.parentNode) {
                        demon.element.parentNode.removeChild(demon.element);
                    }
                });
                activeDemons = [];
                
                if (currentLevel === 1) {
                    // Create exactly one demon of each type at different positions
                    let demon1 = createDemon(2, 800);  // Demon type 1
                    let demon2 = createDemon(1, 1500); // Demon type 2
                    let demon3 = createDemon(0, 2200); // Demon type 3
                    
                    if (demon1) activeDemons.push(demon1);
                    if (demon2) activeDemons.push(demon2);
                    if (demon3) activeDemons.push(demon3);
                } else if (currentLevel === 2) {
                    // Create exactly one demon of each Level 2 type
                    let demon1 = createDemon(0, 800);  // Level 2 - Demon type 1
                    let demon2 = createDemon(1, 1500); // Level 2 - Demon type 2
                    let demon3 = createDemon(2, 2200); // Level 2 - Demon type 3
                    let demon4 = createDemon(3, 2900); // Level 2 - Demon type 4
                    
                    if (demon1) activeDemons.push(demon1);
                    if (demon2) activeDemons.push(demon2);
                    if (demon3) activeDemons.push(demon3);
                    if (demon4) activeDemons.push(demon4);
                } else if (currentLevel === 3) {
                    // Create exactly one demon of each Level 3 type
                    let demon1 = createDemon(1, 800);  // Level 3 - Demon type 1
                    let demon2 = createDemon(0, 1500); // Level 3 - Demon type 2
                    let demon3 = createDemon(2, 2200); // Level 3 - Demon type 3
                    let demon4 = createDemon(3, 2900); // Level 3 - Demon type 4
                    
                    if (demon1) activeDemons.push(demon1);
                    if (demon2) activeDemons.push(demon2);
                    if (demon3) activeDemons.push(demon3);
                    if (demon4) activeDemons.push(demon4);
                }
            }
           
            // Create a portal for level transition
            function createPortal() {
                if (portalObject) {
                    if (portalObject.element && portalObject.element.parentNode) {
                        portalObject.element.parentNode.removeChild(portalObject.element);
                    }
                    portalObject = null;
                }
               
                const portal = document.createElement('div');
                portal.className = 'portal';
                
                // Use different portal images for different levels
                if (currentLevel === 1) {
                    portal.classList.add('level-one-portal');
                } else {
                    portal.classList.add('other-level-portal');
                }
               
                const portalX = currentLevel === 3 ? 4500 : 4500; // Final portal position for level 3
                portal.style.left = portalX + 'px';
                portal.style.bottom = '100px';
                gameContainer.appendChild(portal);
                gameElements.push(portal);
               
                portalObject = {
                    element: portal,
                    x: portalX,
                    y: 100,
                    width: 100,
                    height: 100,
                    relativeX: portalX
                };
            }
           
            // Setup player
            function setupPlayer() {
                if (player) {
                    player.remove();
                }
               
                player = document.createElement('div');
                player.id = 'player';
                gameContainer.appendChild(player);
                gameElements.push(player);
               
                player.style.bottom = '100px';
                player.style.left = playerX + 'px';
            }
           
            // Check if player collides with a demon
            function checkDemonCollision() {
                // Get player hitbox (a bit smaller than visual size - 75% of image size)
                const playerHitboxWidth = 80 * 0.75;
                const playerHitboxHeight = 120 * 0.75;
               
                const playerLeft = playerX;
                const playerRight = playerX + playerHitboxWidth;
                const playerTop = playerY + playerHitboxHeight;
                const playerBottom = playerY;
               
                activeDemons.forEach(demon => {
                    if (!demon.active) return;
                   
                    // Adjust demon position based on background scrolling
                    const demonScreenX = demon.relativeX - backgroundPos;
                   
                    const demonLeft = demonScreenX;
                    const demonRight = demonScreenX + demon.width;
                    const demonTop = demon.y + demon.height;
                    const demonBottom = demon.y;
                   
                    if (
                        playerRight > demonLeft &&
                        playerLeft < demonRight &&
                        playerTop > demonBottom &&
                        playerBottom < demonTop
                    ) {
                        // Collision detected
                        if (!isInvincible) {
                            lives--;
                            updateLives();
                            makePlayerInvincible();
                           
                            // Add 'hit' animation or effect
                            player.classList.add('player-invincible');
                            setTimeout(() => {
                                player.classList.remove('player-invincible');
                            }, invincibleDuration);
                        }
                    }
                });
            }
           
            // Check if player has reached the portal
            function checkPortalCollision() {
                if (!portalObject) return false;
               
                // Get player hitbox
                const playerHitboxWidth = 80 * 0.75;
                const playerHitboxHeight = 120 * 0.75;
               
                const playerLeft = playerX;
                const playerRight = playerX + playerHitboxWidth;
                const playerTop = playerY + playerHitboxHeight;
                const playerBottom = playerY;
               
                // Adjust portal position based on background scrolling
                const portalScreenX = portalObject.relativeX - backgroundPos;
               
                const portalLeft = portalScreenX;
                const portalRight = portalScreenX + portalObject.width;
                const portalTop = portalObject.y + portalObject.height;
                const portalBottom = portalObject.y;
               
                if (
                    playerRight > portalLeft &&
                    playerLeft < portalRight &&
                    playerTop > portalBottom &&
                    playerBottom < portalTop
                ) {
                    return true;
                }
               
                return false;
            }
           
            // Make player invincible temporarily
            function makePlayerInvincible() {
                isInvincible = true;
                setTimeout(() => {
                    isInvincible = false;
                }, invincibleDuration);
            }
           
            // Handle player movement and game mechanics
            function updateGame() {
                if (!gameLoopRunning) return;
               
                // Apply speed boost if shift key is pressed
                let currentMoveSpeed = keysPressed.ShiftLeft ? moveSpeed * 1.5 : moveSpeed;
               
                // Handle left/right movement
                if (keysPressed.ArrowLeft) {
                    facingRight = false;
                    player.style.transform = 'scaleX(-1)';
                   
                    if (playerX > playerMinX) {
                        playerX -= currentMoveSpeed;
                    } else if (backgroundPos > 0) {
                        backgroundPos -= currentMoveSpeed;
                        updateBackgroundPosition();
                    }
                }
               
                if (keysPressed.ArrowRight) {
                    facingRight = true;
                    player.style.transform = 'scaleX(1)';
                   
                    if (playerX < playerMaxX) {
                        playerX += currentMoveSpeed;
                    } else if (backgroundPos < maxBackgroundPos) {
                        backgroundPos += currentMoveSpeed;
                        updateBackgroundPosition();
                    }
                }
               
                // Handle jumping with Space or ArrowUp
                if ((keysPressed.Space || keysPressed.ArrowUp) && !isJumping && !isFalling) {
                    isJumping = true;
                    jumpHeight = 0;
                }
               
                // Jump physics
                if (isJumping) {
                    jumpHeight += 10;
                    playerY = 100 + jumpHeight;
                   
                    if (jumpHeight >= jumpMax) {
                        isJumping = false;
                        isFalling = true;
                    }
                }
               
                // Falling physics
                if (isFalling) {
                    jumpHeight -= 10;
                    playerY = 100 + jumpHeight;
                   
                    if (jumpHeight <= 0) {
                        jumpHeight = 0;
                        playerY = 100;
                        isFalling = false;
                    }
                }
               
                // Position player
                player.style.bottom = playerY + 'px';
                player.style.left = playerX + 'px';
               
                // Update demon positions
                updateDemons();
               
                // Check for collisions
                checkDemonCollision();
               
                // Check for portal collision
                if (checkPortalCollision() && !levelTransitioning) {
                    levelComplete();
                }
               
                // Calculate current screen based on background position
                currentScreen = Math.floor(backgroundPos / screenWidth);
                screenPositionDisplay.textContent = `${currentScreen} (${Math.floor(backgroundPos)})`;
               
                // Request next animation frame
                animationFrameId = requestAnimationFrame(updateGame);
            }
           
            // Update positions of active demons
            function updateDemons() {
                activeDemons.forEach(demon => {
                    if (!demon.active) return;
                   
                    // Calculate demon's on-screen position
                    const demonScreenX = demon.relativeX - backgroundPos;
                   
                    // Simple back-and-forth movement pattern
                    demon.relativeX += demon.speed * (Math.sin(Date.now() * 0.001) * 2);
                   
                    // Update demon's element position
                    demon.element.style.left = demonScreenX + 'px';
                });
            }
           
            // Update background position
            function updateBackgroundPosition() {
                backgroundLayer.style.transform = `translateX(-${backgroundPos}px)`;
            }
           
            // Update game timer
            function updateTimer() {
                timeRemaining--;
                timeDisplay.textContent = timeRemaining;
               
                if (timeRemaining <= 0) {
                    gameOver();
                }
            }
           
            // Level complete
            function levelComplete() {
                levelTransitioning = true;
                clearInterval(timerInterval);
                cancelAnimationFrame(animationFrameId);
                gameLoopRunning = false;
               
                // Calculate score bonus based on time remaining
                const timeBonus = timeRemaining * 10;
                score += timeBonus;
                scoreDisplay.textContent = score;
               
                if (currentLevel === 3) {
                    // Game completed
                    gameCompleted();
                    return;
                }
               
                // Create level complete message
                const levelCompleteDiv = document.createElement('div');
                levelCompleteDiv.className = 'level-complete';
                levelCompleteDiv.innerHTML = `
                    <h2>Livello ${currentLevel} Completato!</h2>
                    <p>Bonus tempo: ${timeBonus}</p>
                    <p>Punteggio totale: ${score}</p>
                `;
               
                // Add restart button
                const continueButton = document.createElement('button');
                continueButton.textContent = 'Continua';
                continueButton.addEventListener('click', startNextLevel);
                levelCompleteDiv.appendChild(continueButton);
               
                // Add to DOM
                gameContainer.appendChild(levelCompleteDiv);
            }
           
            // Start next level
            function startNextLevel() {
                // Remove level complete message
                const levelCompleteDiv = document.querySelector('.level-complete');
                if (levelCompleteDiv) {
                    levelCompleteDiv.remove();
                }
               
                // Increment level
                currentLevel++;
                worldDisplay.textContent = `${currentLevel}-1`;
               
                // Reset player position
                playerX = 100;
                playerY = 100;
                backgroundPos = 0;
                updateBackgroundPosition();
               
                // Reset timer
                timeRemaining = 400;
                timeDisplay.textContent = timeRemaining;
               
                // Change background for level 2 or 3
                if (currentLevel === 2) {
                    backgroundLayer.classList.add('level-two-background');
                    backgroundLayer.classList.remove('level-three-background');
                } else if (currentLevel === 3) {
                    backgroundLayer.classList.add('level-three-background');
                    backgroundLayer.classList.remove('level-two-background');
                }
               
                // Setup game elements
                setupPlayer();
                spawnDemons();
                createPortal();
               
                // Reset transition flag and restart game
                levelTransitioning = false;
                gameLoopRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                animationFrameId = requestAnimationFrame(updateGame);
            }
           
            // Game over
            function gameOver() {
                clearInterval(timerInterval);
                cancelAnimationFrame(animationFrameId);
                gameLoopRunning = false;
               
                // Create game over message
                const gameOverDiv = document.createElement('div');
                gameOverDiv.className = 'game-over';
                gameOverDiv.innerHTML = `
                    <h2>Game Over</h2>
                    <p>Punteggio finale: ${score}</p>
                `;
               
                // Add restart button
                const restartButton = document.createElement('button');
                restartButton.textContent = 'Riprova';
                restartButton.addEventListener('click', restartGame);
                gameOverDiv.appendChild(restartButton);
               
                // Add to DOM
                gameContainer.appendChild(gameOverDiv);
            }
           
            // Game completed
            function gameCompleted() {
                clearInterval(timerInterval);
                cancelAnimationFrame(animationFrameId);
                gameLoopRunning = false;
               
                // Show final image
                finalImage.style.display = 'block';
               
                // Create game completed message
                const gameCompletedDiv = document.createElement('div');
                gameCompletedDiv.className = 'game-over';
                gameCompletedDiv.style.backgroundColor = 'rgba(0, 100, 0, 0.8)';
                gameCompletedDiv.innerHTML = `
                    <h2 style="color: #4CAF50;">Congratulazioni!</h2>
                    <p>Hai completato il viaggio di Dante attraverso l'Inferno!</p>
                    <p>Punteggio finale: ${score}</p>
                `;
               
                // Add restart button
                const restartButton = document.createElement('button');
                restartButton.textContent = 'Gioca ancora';
                restartButton.addEventListener('click', function() {
                    finalImage.style.display = 'none';
                    restartGame();
                });
                gameCompletedDiv.appendChild(restartButton);
               
                // Add to DOM
                gameContainer.appendChild(gameCompletedDiv);
            }
           
            // Restart game
            function restartGame() {
                // Remove game over message
                const gameOverDiv = document.querySelector('.game-over');
                if (gameOverDiv) {
                    gameOverDiv.remove();
                }
               
                // Reset game variables
                lives = 5;
                score = 0;
                timeRemaining = 400;
                currentLevel = 1;
                playerX = 100;
                playerY = 100;
                backgroundPos = 0;
                updateBackgroundPosition();
               
                // Reset background to level 1
                backgroundLayer.classList.remove('level-two-background');
                backgroundLayer.classList.remove('level-three-background');
               
                // Update displays
                scoreDisplay.textContent = score;
                timeDisplay.textContent = timeRemaining;
                worldDisplay.textContent = `${currentLevel}-1`;
                updateLives();
               
                // Setup game elements
                setupPlayer();
                spawnDemons();
                createPortal();
               
                // Restart game loop
                gameLoopRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                animationFrameId = requestAnimationFrame(updateGame);
            }
           
            // Start game function
            function startGame() {
                // Hide start screen
                startScreen.style.display = 'none';
               
                // Initialize game
                initLives();
                setupPlayer();
                spawnDemons();
                createPortal();
               
                // Start game loop
                gameLoopRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                animationFrameId = requestAnimationFrame(updateGame);
            }
           
            // Handle window resize
            window.addEventListener('resize', function() {
                viewportWidth = window.innerWidth;
                screenWidth = viewportWidth;
                playerMaxX = viewportWidth / 2;
                maxBackgroundPos = levelWidth - viewportWidth;
            });
           
            // Setup keyboard listeners
            setupKeyboardListeners();
           
            // Sound button functionality
            let soundEnabled = true;
            soundButton.addEventListener('click', function() {
                soundEnabled = !soundEnabled;
                soundButton.textContent = soundEnabled ? '🔊' : '🔇';
            });
        });
    </script>
</body>
</html>
